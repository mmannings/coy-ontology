download:
  stage: download
  #rules:
  #  - if: '$CI_COMMIT_TAG =~ /^verified20/'
  image:
    name: alpine/git:latest
    entrypoint: [""]
  artifacts:
    when: always
    paths:
      - "./java-17-widoco-1.4.17-jar-with-dependencies.jar"
      - "void.stats.ttl"
    public: false
  script:
    - rm -rf ./dist ./repo
    - wget https://github.com/dgarijo/Widoco/releases/download/v1.4.17/java-17-widoco-1.4.17-jar-with-dependencies.jar
    # get void statistics
    - git config --global user.email "kjunghanns@informatik.uni-leipzig.de" &&  git config --global user.name "bot_push_coypu"
    - git clone "https://bot_push_coypu:$GITLAB_PAC_PUSH@gitlab.com/coypu-project/dataset-stats.git" void
    - cp void/implisense-stats.nt void.stats.ttl

stats:
  stage: stats
  #rules:
  #  - if: '$CI_COMMIT_TAG =~ /^verified20/'
  image:
    name: tboonx/rpt:jena-4.6.0
    entrypoint: [""]
  artifacts:
    when: always
    paths:
      - "coy.withStats.ttl"
    public: false
  script:
    - cat coy.ttl > main.ttl
    - java -jar /rpt.jar integrate -o=onlyVoid.nt --out-format=ntriples void.stats.ttl scripts/extractVoidInformation.rq
    - cat onlyVoid.nt >> main.ttl
    - java -jar /rpt.jar integrate -o=x.nt --out-format=ntriples main.ttl scripts/createParentClassStatInfo.rq
    - cat x.nt >> main.ttl
    - java -jar /rpt.jar integrate -o=coy.withStats.nt --out-format=ntriples main.ttl scripts/createNotInUseStatus.rq
    - cat coy.withStats.nt >> main.ttl
    - java -jar /rpt.jar integrate -o=coy.missing.nt --out-format=ntriples void.stats.ttl main.ttl scripts/usedButNotInOnto.rq
    - cat coy.missing.nt >> main.ttl
    - mv main.ttl coy.withStats.ttl

widoco:
  stage: widoco
  #rules:
  #  - if: '$CI_COMMIT_TAG =~ /^verified20/'
  image:
    name: openjdk:17-oracle
    entrypoint: [""]
  artifacts:
    when: always
    paths:
      - "./dist"
    public: true
  script:
    - java -jar java-17-widoco-1.4.17-jar-with-dependencies.jar -ontFile ./coy.withStats.ttl -lang en -webVowl -licensius -includeAnnotationProperties -uniteSections -noPlaceHolderText -outFolder dist
    - |
        sed -i -e "/<\/body>/i \
          <script type=\"text/javascript\">\\
            var x = document.evaluate(\"//dl[./dd[text()='---USED BUT NOT IN ONTOLOGY---']]\", document, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null);\
            for (var i = 0; i < x.snapshotLength; i++) {\
              x.snapshotItem(i).style='background-color:red';\
            }\
            var x = document.evaluate(\"//dl[./dd[text()='Not in use']]\", document, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null);\
            for (var i = 0; i < x.snapshotLength; i++) {\
              x.snapshotItem(i).style='background-color:yellow';\
            }\\
          </script>
        " dist/index-en.html

ontodiff:
  stage: ontodiff
  artifacts:
    when: always
    paths:
      - "./diff"
    public: true
  image:
    name: registry.gitlab.com/coypu-project/coy-ontology/bubastis
    entrypoint: [""]
  script:
    - mkdir -p diff
    - cp coy.ttl diff/coy.ttl
    - git show $CI_MERGE_REQUEST_DIFF_BASE_SHA:coy.ttl > diff/coy_orig.ttl
    - cd diff
    - /app/run.sh coy_orig.ttl coy.ttl
  rules:
    - if: $CI_MERGE_REQUEST_ID

cd:
  stage: cd
  rules:
    - if: '$CI_COMMIT_TAG =~ /^verified20/'
  image:
    name: alpine/git:latest
    entrypoint: [""]
  script:
    - mv dist/index-en.html dist/index.html && rm dist/readme.md
    - git config --global user.email "kjunghanns@informatik.uni-leipzig.de" &&  git config --global user.name "bot_push_coypu"
    - git clone "https://bot_push_coypu:$GITLAB_PAC_PUSH@gitlab.com/coypu-project/coy-documentation.git" repo && cd repo && cp -r ../dist/* ./public/
    - git add . && git commit -am "CD" && git push "https://bot_push_coypu:$GITLAB_PAC_PUSH@gitlab.com/coypu-project/coy-documentation.git" HEAD:main

deploy_review:
  image: node:16
  stage: cd
  needs:
    - widoco
  before_script:
    - npm install surge --save-dev
  script:
    - mv dist/index-en.html dist/index.html && rm dist/readme.md
    - npx surge dist/ $CI_COMMIT_REF_SLUG-coy-onto-preview.surge.sh --token $SURGE_TOKEN
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: https://$CI_COMMIT_REF_SLUG-coy-onto-preview.surge.sh
    on_stop: stop_deploy_review
    auto_stop_in: 1 week
  rules:
    - if: $CI_MERGE_REQUEST_ID

stop_deploy_review:
  image: node:16
  stage: cd
  variables:
    GIT_STRATEGY: none
  before_script:
    - npm install surge --save-dev
  script:
    - npx surge teardown $CI_COMMIT_REF_SLUG-coy-onto-preview.surge.sh --token $SURGE_TOKEN
  environment:
    name: review/$CI_COMMIT_REF_NAME
    action: stop
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: manual
      allow_failure: true
